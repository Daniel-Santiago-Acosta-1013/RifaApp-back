name: Trigger Infra Deploy

on:
  workflow_dispatch:

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Validate infra repo
        env:
          INFRA_REPO: ${{ vars.INFRA_REPO }}
        run: |
          if [ -z "$INFRA_REPO" ]; then
            echo "INFRA_REPO is not set" >&2
            exit 1
          fi

      - name: Dispatch deploy to infra repo and wait
        uses: peter-evans/workflow-dispatch@v2
        with:
          token: ${{ secrets.INFRA_DISPATCH_TOKEN }}
          repository: ${{ vars.INFRA_REPO }}
          workflow: deploy.yml
          ref: main
          wait-for-completion: true
          interval: 20
          timeout: 1800
